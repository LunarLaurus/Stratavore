<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratavore Job Tracker - Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Courier New', monospace; 
            background: #1a1a1a; 
            color: #00ff00; 
            line-height: 1.4;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #00ff00; margin-bottom: 10px; }
        .header p { color: #888; font-size: 0.9em; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { 
            background: #2a2a2a; 
            border: 1px solid #00ff00; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,255,0,0.1);
        }
        .card h3 { color: #00ff00; margin-bottom: 15px; font-size: 1.2em; }
        .error { background: #3a2a2a; border-color: #ff0000; }
        .error h3 { color: #ff0000; }
        .loading { 
            background: #2a2a2a; 
            border: 1px solid #ffff00; 
            color: #ffff00;
            text-align: center;
            padding: 40px;
        }
        .job-list { max-height: 500px; overflow-y: auto; }
        .job { 
            background: #333; 
            margin: 15px 0; 
            padding: 15px; 
            border-left: 4px solid #00ff00; 
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .job:hover { 
            background: #444; 
            transform: translateX(5px);
        }
        .job.high { border-left-color: #ff0000; }
        .job.medium { border-left-color: #ffff00; }
        .job.low { border-left-color: #0066ff; }
        .job.in-progress { background: #444; border-left-color: #00ffff; }
        .job.completed { background: #2d4a2d; opacity: 0.8; }
        .job-title { font-weight: bold; margin-bottom: 8px; font-size: 1.1em; }
        .job-meta { font-size: 0.9em; color: #ccc; }
        .job-meta p { margin: 3px 0; }
        .job-meta strong { color: #fff; }
        .agents { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .agent { 
            background: #2a2a2a; 
            padding: 15px; 
            border: 1px solid #00ff00; 
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .agent:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,255,0,0.2); }
        .agent h4 { color: #00ff00; margin-bottom: 10px; }
        .time-sessions { max-height: 400px; overflow-y: auto; }
        .time-session { 
            background: #333; 
            margin: 15px 0; 
            padding: 15px; 
            border-left: 4px solid #00ffff; 
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .time-session.active { 
            border-left-color: #00ff00; 
            background: #444; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        .session-title { font-weight: bold; margin-bottom: 8px; color: #00ffff; }
        .session-details p { margin: 5px 0; font-size: 0.9em; }
        .session-details strong { color: #fff; }
        .refresh-btn { 
            background: #00ff00; 
            color: #000; 
            border: none; 
            padding: 12px 25px; 
            cursor: pointer; 
            margin: 10px 5px;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover { 
            background: #00cc00; 
            transform: scale(1.05);
        }
        .debug-panel {
            background: #1a1a1a;
            border: 1px solid #ff00ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .debug-panel h4 { color: #ff00ff; margin-bottom: 10px; }
        .debug-info { font-size: 0.8em; color: #ccc; }
        .last-updated { 
            text-align: center; 
            color: #888; 
            margin-top: 20px; 
            font-size: 0.9em;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.online { background: #00ff00; }
        .status-indicator.error { background: #ff0000; }
        .status-indicator.warning { background: #ffff00; }
        .agent-status-panel { max-height: 400px; overflow-y: auto; }
        .agent-status-item { 
            background: #333; 
            margin: 10px 0; 
            padding: 15px; 
            border-left: 4px solid #00ffff; 
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .agent-status-item.working { 
            border-left-color: #00ff00; 
            background: #444; 
        }
        .agent-status-item.idle { 
            border-left-color: #0066ff; 
        }
        .agent-status-item.spawning { 
            border-left-color: #ffff00; 
            animation: pulse 2s infinite;
        }
        .agent-status-item.error { 
            border-left-color: #ff0000; 
        }
        .agent-header { 
            font-weight: bold; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center;
            gap: 8px;
        }
        .agent-emoji { 
            font-size: 1.2em; 
        }
        .agent-details p { 
            margin: 5px 0; 
            font-size: 0.9em; 
            color: #ccc; 
        }
        .agent-details strong { 
            color: #fff; 
        }
        .agent-todos {
            max-height: 400px;
            overflow-y: auto;
        }
        .todo-item {
            border: 1px solid #444;
            border-radius: 4px;
            margin: 10px 0;
            padding: 12px;
            background: #2a2a2a;
        }
        .todo-item.completed {
            border-left: 4px solid #28a745;
            background: #1e3a1e;
        }
        .todo-item.in-progress {
            border-left: 4px solid #ffc107;
            background: #3a3a1e;
        }
        .todo-item.cancelled {
            border-left: 4px solid #dc3545;
            background: #3a1e1e;
        }
        .todo-item.pending {
            border-left: 4px solid #6c757d;
            background: #2a2a2a;
        }
        .todo-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .todo-title {
            font-weight: bold;
            color: #fff;
        }
        .todo-agent {
            color: #6c757d;
            font-size: 0.9em;
        }
        .todo-description {
            color: #ccc;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .todo-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #888;
        }
        .todo-task {
            color: #007bff;
        }
        .no-todos {
            color: #6c757d;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ STRATAVORE JOB TRACKER v3</h1>
            <p>Parallel agent workflows with real-time monitoring</p>
            <div style="margin: 20px 0;">
                <span class="status-indicator" id="connection-status"></span>
                <span id="connection-text">Checking connection...</span>
                <button class="refresh-btn" onclick="loadData()">ğŸ”„ REFRESH DATA</button>
                <button class="refresh-btn" onclick="loadHealth()">ğŸ¥ HEALTH CHECK</button>
                <button class="refresh-btn" onclick="toggleDebug()">ğŸ”§ TOGGLE DEBUG</button>
            </div>
        </div>

        <div class="debug-panel" id="debug-panel" style="display: none;">
            <h4>ğŸ”§ DEBUG INFO</h4>
            <div class="debug-info" id="debug-info">Loading debug information...</div>
        </div>

        <div class="status-grid">
            <div class="card">
                <h3>ğŸ“Š OVERVIEW</h3>
                <div id="overview"><div class="loading">ğŸ”„ Loading overview...</div></div>
            </div>
            <div class="card">
                <h3>ğŸ¯ PRIORITY BREAKDOWN</h3>
                <div id="priority-breakdown"><div class="loading">ğŸ”„ Loading priorities...</div></div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“‹ ACTIVE JOBS (<span id="active-job-count">0</span>)</h3>
            <div class="job-list" id="jobs-container">
                <div class="loading">ğŸ”„ Loading jobs...</div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ¤– AGENT STATUS &amp; WORKFLOW</h3>
            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
                <button class="refresh-btn" onclick="spawnAgent()">ğŸš€ SPAWN AGENT</button>
                <button class="refresh-btn" onclick="toggleAgentControls()">ğŸ› AGENT CONTROLS</button>
            </div>

            <!-- Agent controls panel (hidden by default) -->
            <div id="agent-controls" style="display:none; background:#1e1e1e; border:1px solid #444; border-radius:6px; padding:15px; margin-bottom:15px;">
                <h4 style="color:#00ffff; margin-bottom:12px;">ğŸ› Agent Control Panel</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <!-- Assign task -->
                    <div style="background:#2a2a2a; padding:12px; border-radius:5px; border:1px solid #333;">
                        <p style="color:#fff; font-weight:bold; margin-bottom:8px;">ğŸ“‹ Assign Task</p>
                        <input id="ctrl-assign-agent" type="text" placeholder="Agent ID" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                        <input id="ctrl-assign-task" type="text" placeholder="Task ID (e.g. JOB-001)" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                        <button class="refresh-btn" style="padding:8px 14px; margin:0;" onclick="ctrlAssignTask()">Assign</button>
                    </div>
                    <!-- Complete task -->
                    <div style="background:#2a2a2a; padding:12px; border-radius:5px; border:1px solid #333;">
                        <p style="color:#fff; font-weight:bold; margin-bottom:8px;">âœ… Complete Task</p>
                        <input id="ctrl-complete-agent" type="text" placeholder="Agent ID" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                        <input id="ctrl-complete-notes" type="text" placeholder="Notes (optional)" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                        <select id="ctrl-complete-success" style="margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                            <option value="true">âœ… Success</option>
                            <option value="false">âŒ Failed</option>
                        </select>
                        <button class="refresh-btn" style="padding:8px 14px; margin:0;" onclick="ctrlCompleteTask()">Complete</button>
                    </div>
                    <!-- Update status -->
                    <div style="background:#2a2a2a; padding:12px; border-radius:5px; border:1px solid #333;">
                        <p style="color:#fff; font-weight:bold; margin-bottom:8px;">ğŸ“¡ Update Status</p>
                        <input id="ctrl-status-agent" type="text" placeholder="Agent ID" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                        <select id="ctrl-status-value" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                            <option value="idle">ğŸ˜´ Idle</option>
                            <option value="working">ğŸ”¨ Working</option>
                            <option value="paused">â¸ï¸ Paused</option>
                            <option value="error">âŒ Error</option>
                        </select>
                        <input id="ctrl-status-thought" type="text" placeholder="Thought (optional)" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                        <button class="refresh-btn" style="padding:8px 14px; margin:0;" onclick="ctrlUpdateStatus()">Update</button>
                    </div>
                    <!-- Kill agent -->
                    <div style="background:#2a2a2a; padding:12px; border-radius:5px; border:1px solid #333;">
                        <p style="color:#fff; font-weight:bold; margin-bottom:8px;">ğŸ”´ Kill Agent</p>
                        <input id="ctrl-kill-agent" type="text" placeholder="Agent ID" style="width:100%; margin-bottom:6px; padding:6px; background:#1a1a1a; color:#0f0; border:1px solid #444; border-radius:3px; font-family:monospace;">
                        <p style="color:#888; font-size:0.8em; margin-bottom:6px;">Marks agent as error state</p>
                        <button class="refresh-btn" style="padding:8px 14px; margin:0; background:#cc0000;" onclick="ctrlKillAgent()">Kill</button>
                    </div>
                </div>
                <div id="ctrl-result" style="margin-top:10px; padding:8px; border-radius:4px; display:none;"></div>
            </div>

            <div class="agents-status-panel" id="agents-status-panel">
                <div class="loading">ğŸ”„ Loading agents...</div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ AGENT ACTIVITY LOG</h3>
            <div class="agent-todos" id="agent-todos-container">
                <div class="loading">ğŸ”„ Loading agent activities...</div>
            </div>
        </div>

        <div class="card">
            <h3>â±ï¸ TIME TRACKING (<span id="active-session-count">0</span> active)</h3>
            <div class="time-sessions" id="time-sessions-container">
                <div class="loading">ğŸ”„ Loading time sessions...</div>
            </div>
        </div>

        <div class="last-updated" id="last-updated">Last updated: Loading...</div>
    </div>

    <script>
        let jobs = [];
        let progress = {};
        let timeSessions = [];
        let agents = {};
        let agentTodos = [];
        let lastUpdate = null;
        let refreshInterval = null;
        let debugMode = false;

        // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function formatDuration(seconds) {
            if (!seconds || seconds < 0) return '0:00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function getAgentStatusEmoji(status) {
            return { idle:'ğŸ˜´', working:'ğŸ”¨', spawning:'ğŸš€', completed:'âœ…', error:'âŒ', paused:'â¸ï¸' }[status] || 'â“';
        }

        function getAgentPersonalityEmoji(personality) {
            return { cadet:'ğŸ‘¨â€ğŸš€', senior:'ğŸ‘´', specialist:'ğŸ¯', researcher:'ğŸ”¬', debugger:'ğŸ›', optimizer:'âš¡' }[personality] || 'ğŸ¤–';
        }

        function updateConnectionStatus(online, message) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            indicator.className = 'status-indicator ' + (online ? 'online' : 'error');
            text.textContent = message || (online ? 'Connected' : 'Connection error');
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debug-panel').style.display = debugMode ? 'block' : 'none';
        }

        function toggleAgentControls() {
            const ctrl = document.getElementById('agent-controls');
            ctrl.style.display = ctrl.style.display === 'none' ? 'block' : 'none';
        }

        function showCtrlResult(msg, ok) {
            const el = document.getElementById('ctrl-result');
            el.style.display = 'block';
            el.style.background = ok ? '#1e3a1e' : '#3a1e1e';
            el.style.color = ok ? '#00ff00' : '#ff4444';
            el.style.border = '1px solid ' + (ok ? '#00ff00' : '#ff4444');
            el.textContent = msg;
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        // â”€â”€ Connection / data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadData() {
            try {
                updateConnectionStatus(false, 'Loading data...');
                const res = await fetch('/api/status');
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.error || 'Unknown API error');

                jobs        = data.jobs         || [];
                progress    = data.progress      || {};
                timeSessions = data.time_sessions || [];
                agents      = data.agents        || {};
                agentTodos  = data.agent_todos   || [];
                lastUpdate  = data.timestamp;

                updateUI();
                updateConnectionStatus(true,
                    `Loaded ${jobs.length} jobs Â· ${Object.keys(agents).length} agents Â· ${timeSessions.length} sessions`);
                if (debugMode) updateDebugInfo(data);
            } catch (err) {
                console.error('loadData error:', err);
                updateConnectionStatus(false, 'Error: ' + err.message);
                document.getElementById('overview').innerHTML =
                    `<div class="error">âŒ Failed to load: ${err.message}</div>`;
            }
        }

        async function loadHealth() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                updateConnectionStatus(data.status === 'healthy',
                    data.status === 'healthy'
                        ? `Server healthy (uptime: ${Math.floor(data.uptime)}s)`
                        : 'Health check failed');
            } catch (err) {
                updateConnectionStatus(false, 'Health check failed');
            }
        }

        function updateDebugInfo(data) {
            const agentCount = Object.keys(agents).length;
            const working = Object.values(agents).filter(a => a.status === 'working').length;
            const idle    = Object.values(agents).filter(a => a.status === 'idle').length;
            document.getElementById('debug-info').innerHTML = `
                <p><strong>Timestamp:</strong> ${data.timestamp ? new Date(data.timestamp*1000).toLocaleString() : 'N/A'}</p>
                <p><strong>Jobs:</strong> ${(data.jobs||[]).length} Â· <strong>Sessions:</strong> ${(data.time_sessions||[]).length}</p>
                <p><strong>Agents total:</strong> ${agentCount} Â· <strong>Working:</strong> ${working} Â· <strong>Idle:</strong> ${idle}</p>
                <p><strong>API status:</strong> ${data.status || 'N/A'} Â· <strong>Error:</strong> ${data.error || 'none'}</p>
            `;
        }

        // â”€â”€ UI update orchestrator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function updateUI() {
            updateOverview();
            updatePriorityBreakdown();
            updateJobsList();
            updateAgentsPanel();
            updateAgentTodos();
            updateTimeTracking();
            updateLastUpdated();
        }

        // â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function updateOverview() {
            const el = document.getElementById('overview');
            if (!el) return;
            const total    = jobs.length;
            const pending  = jobs.filter(j => j.status === 'pending').length;
            const inProg   = jobs.filter(j => j.status === 'in_progress').length;
            const done     = jobs.filter(j => j.status === 'completed').length;
            // FIX: properly call .toFixed() on the number, not append it to a string
            const trackedH = (timeSessions.reduce((s, x) => s + (x.duration_seconds || 0), 0) / 3600).toFixed(2);
            el.innerHTML = `
                <p><strong>Total Jobs:</strong> ${total}</p>
                <p><strong>ğŸŸ¡ Pending:</strong> ${pending}</p>
                <p><strong>ğŸŸ  In Progress:</strong> ${inProg}</p>
                <p><strong>ğŸŸ¢ Completed:</strong> ${done}</p>
                <p><strong>Completion Rate:</strong> ${total > 0 ? Math.round((done/total)*100) : 0}%</p>
                <p><strong>ğŸ“Š Total Tracked Hours:</strong> ${trackedH}h</p>
            `;
        }

        // â”€â”€ Priority breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function updatePriorityBreakdown() {
            const el = document.getElementById('priority-breakdown');
            if (!el) return;
            const active = jobs.filter(j => j.status !== 'completed');
            el.innerHTML = `
                <p><strong>ğŸ”´ High:</strong> ${active.filter(j => j.priority === 'high').length}</p>
                <p><strong>ğŸŸ¡ Medium:</strong> ${active.filter(j => j.priority === 'medium').length}</p>
                <p><strong>ğŸ”µ Low:</strong> ${active.filter(j => j.priority === 'low').length}</p>
                <p><strong>ğŸ“Š Active Total:</strong> ${active.length}</p>
            `;
        }

        // â”€â”€ Jobs list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function calculateJobTime(jobId) {
            let totalSeconds = 0;
            timeSessions.filter(s => s.job_id === jobId).forEach(s => {
                if (s.status === 'completed' && s.duration_seconds) {
                    totalSeconds += s.duration_seconds;
                } else if (s.status === 'active') {
                    totalSeconds += (Date.now()/1000 - s.start_timestamp - (s.paused_time||0));
                }
            });
            return { totalSeconds, totalHours: totalSeconds/3600, formattedTime: formatDuration(totalSeconds) };
        }

        function updateJobsList() {
            const el = document.getElementById('jobs-container');
            if (!el) return;
            const active = jobs
                .filter(j => j.status !== 'completed')
                .sort((a,b) => ({'high':0,'medium':1,'low':2}[a.priority]||3) - ({'high':0,'medium':1,'low':2}[b.priority]||3));
            document.getElementById('active-job-count').textContent = active.length;
            if (active.length === 0) {
                el.innerHTML = '<div class="loading">âœ… All jobs completed!</div>';
                return;
            }
            el.innerHTML = active.map(job => {
                const jt = calculateJobTime(job.id);
                // FIX: guard against missing dependencies array
                const deps = Array.isArray(job.dependencies) && job.dependencies.length
                    ? `<p><strong>ğŸ”— Dependencies:</strong> ${job.dependencies.join(', ')}</p>` : '';
                return `
                    <div class="job ${job.priority||''} ${(job.status||'').replace('_','-')}">
                        <div class="job-title">ğŸ·ï¸ ${job.title || job.id}</div>
                        <div class="job-meta">
                            <p><strong>ID:</strong> ${job.id}</p>
                            <p><strong>Status:</strong> ${(job.status||'unknown').replace('_',' ').toUpperCase()}</p>
                            <p><strong>Priority:</strong> ${(job.priority||'unknown').toUpperCase()}</p>
                            <p><strong>Agent:</strong> ${job.assignee || 'UNASSIGNED'}</p>
                            <p><strong>Estimate:</strong> ${job.estimated_hours != null ? job.estimated_hours+'h' : 'N/A'}</p>
                            <p><strong>Actual Time:</strong> ${jt.formattedTime}</p>
                            <p><strong>Created:</strong> ${job.created_at ? new Date(job.created_at).toLocaleString() : 'N/A'}</p>
                            ${deps}
                        </div>
                    </div>`;
            }).join('');
        }

        // â”€â”€ Agents panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function updateAgentsPanel() {
            const el = document.getElementById('agents-status-panel');
            if (!el) return;
            const entries = Object.entries(agents);
            if (entries.length === 0) {
                el.innerHTML = '<div class="no-todos">No agents running. Click ğŸš€ SPAWN AGENT to start one.</div>';
                return;
            }
            el.innerHTML = entries.map(([agentId, agent]) => {
                const statusEmoji  = getAgentStatusEmoji(agent.status);
                const persEmoji    = getAgentPersonalityEmoji(agent.personality);
                const lastThought  = (agent.thoughts && agent.thoughts.length)
                    ? agent.thoughts[agent.thoughts.length-1].thought : 'No recent thoughts';
                const tasksComplete = (agent.metrics && agent.metrics.tasks_completed) || 0;
                return `
                    <div class="agent-status-item ${agent.status||''}">
                        <div class="agent-header">
                            <span class="agent-emoji">${statusEmoji}</span>
                            <span class="agent-emoji">${persEmoji}</span>
                            <strong>${agentId}</strong>
                            <span style="color:#888; font-size:0.85em;">(${agent.personality||'unknown'})</span>
                            <button onclick="copyToCtrl('${agentId}')"
                                style="margin-left:auto; padding:2px 8px; font-size:0.75em; background:#333;
                                       color:#0f0; border:1px solid #555; border-radius:3px; cursor:pointer;">
                                use â†—
                            </button>
                        </div>
                        <div class="agent-details">
                            <p><strong>Task:</strong> ${agent.current_task || 'No task assigned'}</p>
                            <p><strong>Thought:</strong> ${lastThought}</p>
                            <p><strong>Completed:</strong> ${tasksComplete} tasks</p>
                            <p><strong>Since:</strong> ${agent.created_at ? new Date(agent.created_at).toLocaleString() : 'N/A'}</p>
                        </div>
                    </div>`;
            }).join('');
        }

        // Convenience: copy an agent ID into all the control input fields
        function copyToCtrl(agentId) {
            ['ctrl-assign-agent','ctrl-complete-agent','ctrl-status-agent','ctrl-kill-agent']
                .forEach(id => { const el = document.getElementById(id); if(el) el.value = agentId; });
            document.getElementById('agent-controls').style.display = 'block';
        }

        // â”€â”€ Agent todos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function updateAgentTodos() {
            const el = document.getElementById('agent-todos-container');
            if (!el) return;
            if (!agentTodos || agentTodos.length === 0) {
                el.innerHTML = '<div class="no-todos">No agent activities yet.</div>';
                return;
            }
            el.innerHTML = agentTodos.slice(0,15).map(todo => {
                const sc = { completed:'completed', in_progress:'in-progress', cancelled:'cancelled' }[todo.status] || 'pending';
                const personality = (todo.metadata && todo.metadata.agent_personality) || 'unknown';
                return `
                    <div class="todo-item ${sc}">
                        <div class="todo-header">
                            <span class="todo-title">${todo.title||'Untitled'}</span>
                            <span class="todo-agent">${todo.agent_id||'?'} (${personality})</span>
                        </div>
                        <div class="todo-description">${todo.description||''}</div>
                        <div class="todo-meta">
                            <span class="todo-time">${todo.created_at ? new Date(todo.created_at).toLocaleString() : ''}</span>
                            ${todo.task_id ? `<span class="todo-task">Task: ${todo.task_id}</span>` : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        // â”€â”€ Time tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function updateTimeTracking() {
            const el = document.getElementById('time-sessions-container');
            if (!el) return;
            const active = timeSessions.filter(s => s.status === 'active');
            const countEl = document.getElementById('active-session-count');
            if (countEl) countEl.textContent = active.length;
            if (active.length === 0) {
                el.innerHTML = '<div class="loading">ğŸ“­ No active time sessions</div>';
                return;
            }
            const now = Date.now() / 1000;
            el.innerHTML = active.map(s => {
                const dur = now - s.start_timestamp - (s.paused_time||0);
                return `
                    <div class="time-session active">
                        <div class="session-title">${s.session_id||'session'}</div>
                        <div class="session-details">
                            <p><strong>Job:</strong> ${s.job_id||'N/A'}</p>
                            <p><strong>Agent:</strong> ${s.agent||'N/A'}</p>
                            <p><strong>Started:</strong> ${new Date(s.start_timestamp*1000).toLocaleTimeString()}</p>
                            <p><strong>Duration:</strong> ${formatDuration(dur)}</p>
                            ${s.description ? `<p><strong>Note:</strong> ${s.description}</p>` : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        function updateLastUpdated() {
            const el = document.getElementById('last-updated');
            if (el) el.textContent = 'Last updated: ' + new Date().toLocaleString();
        }

        // â”€â”€ Spawn agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function spawnAgent() {
            const personalities = ['cadet','senior','specialist','researcher','debugger','optimizer'];
            const personality = prompt(
                'Enter agent personality:\n' + personalities.map((p,i) => `  ${i+1}. ${p}`).join('\n')
            );
            if (!personality) return;
            const norm = personality.trim().toLowerCase()
                .replace(/^\d+\.\s*/,'')  // allow "1. cadet" input
                .replace(/\s+/g,'');
            try {
                const res = await fetch('/api/spawn-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personality: norm })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`âœ… Agent spawned!\nID: ${data.agent_id}\nPersonality: ${data.personality}`);
                    setTimeout(loadData, 1200);
                } else {
                    alert(`âŒ Failed: ${data.error}`);
                }
            } catch (err) {
                alert(`âŒ Network error: ${err.message}`);
            }
        }

        // â”€â”€ Agent control actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function ctrlPost(endpoint, body) {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            return res.json();
        }

        async function ctrlAssignTask() {
            const agentId = document.getElementById('ctrl-assign-agent').value.trim();
            const taskId  = document.getElementById('ctrl-assign-task').value.trim();
            if (!agentId || !taskId) { showCtrlResult('âš ï¸ Agent ID and Task ID are required', false); return; }
            try {
                const data = await ctrlPost('/api/assign-agent', { agent_id: agentId, task_id: taskId });
                if (data.status === 'success') {
                    showCtrlResult(`âœ… Assigned ${taskId} â†’ ${agentId}`, true);
                    setTimeout(loadData, 800);
                } else {
                    showCtrlResult(`âŒ ${data.error}`, false);
                }
            } catch (err) { showCtrlResult(`âŒ Network error: ${err.message}`, false); }
        }

        async function ctrlCompleteTask() {
            const agentId = document.getElementById('ctrl-complete-agent').value.trim();
            const notes   = document.getElementById('ctrl-complete-notes').value.trim();
            const success = document.getElementById('ctrl-complete-success').value === 'true';
            if (!agentId) { showCtrlResult('âš ï¸ Agent ID is required', false); return; }
            try {
                const data = await ctrlPost('/api/complete-task', { agent_id: agentId, success, notes });
                if (data.status === 'success') {
                    showCtrlResult(`âœ… Task marked ${success ? 'complete' : 'failed'} for ${agentId}`, true);
                    setTimeout(loadData, 800);
                } else {
                    showCtrlResult(`âŒ ${data.error}`, false);
                }
            } catch (err) { showCtrlResult(`âŒ Network error: ${err.message}`, false); }
        }

        async function ctrlUpdateStatus() {
            const agentId = document.getElementById('ctrl-status-agent').value.trim();
            const status  = document.getElementById('ctrl-status-value').value;
            const thought = document.getElementById('ctrl-status-thought').value.trim() || null;
            if (!agentId) { showCtrlResult('âš ï¸ Agent ID is required', false); return; }
            try {
                const data = await ctrlPost('/api/agent-status', { agent_id: agentId, status, thought });
                if (data.status === 'success') {
                    showCtrlResult(`âœ… ${agentId} â†’ ${status}`, true);
                    setTimeout(loadData, 800);
                } else {
                    showCtrlResult(`âŒ ${data.error}`, false);
                }
            } catch (err) { showCtrlResult(`âŒ Network error: ${err.message}`, false); }
        }

        async function ctrlKillAgent() {
            const agentId = document.getElementById('ctrl-kill-agent').value.trim();
            if (!agentId) { showCtrlResult('âš ï¸ Agent ID is required', false); return; }
            if (!confirm(`Kill agent ${agentId}?`)) return;
            try {
                const data = await ctrlPost('/api/kill-agent', { agent_id: agentId });
                if (data.status === 'success') {
                    showCtrlResult(`âœ… Agent ${agentId} killed`, true);
                    setTimeout(loadData, 800);
                } else {
                    showCtrlResult(`âŒ ${data.error}`, false);
                }
            } catch (err) { showCtrlResult(`âŒ Network error: ${err.message}`, false); }
        }

        // â”€â”€ Auto-refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadData, 30000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            startAutoRefresh();
        });

        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
        });
    </script>
</body>
</html>