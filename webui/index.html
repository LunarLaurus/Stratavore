<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratavore Job Tracker v4 - Modular Architecture</title>
    
    <!-- CSS Modules -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/components/components.css">
    
    <!-- Component Scripts (Load in dependency order) -->
    <!-- Core Services -->
    <script src="services/event-bus.js"></script>
    <script src="services/api-client.js"></script>
    
    <!-- Base Component -->
    <script src="components/base-component.js"></script>
    
    <!-- UI Components -->
    <script src="components/header-component.js"></script>
    <script src="components/overview-panel-component.js"></script>
    <script src="components/jobs-list-component.js"></script>
    <script src="components/agent-status-component.js"></script>
    
    <!-- Additional components will be added here -->
    
    <style>
        /* Additional styles for debug panel */
        #debug-panel {
            background: #1a1a1a;
            border: 1px solid #ff00ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        
        #debug-panel h4 {
            color: #ff00ff;
            margin-bottom: 10px;
        }
        
        #debug-info {
            font-size: 0.8em;
            color: #ccc;
            font-family: 'Courier New', monospace;
        }
        
        /* Notification styles */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: var(--z-toast);
        }
        
        .notification {
            background: var(--color-surface);
            border-left: 4px solid var(--color-primary);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            animation: slideInRight var(--transition-normal) ease-out;
        }
        
        .notification--success {
            border-left-color: var(--color-success);
        }
        
        .notification--error {
            border-left-color: var(--color-error);
        }
        
        .notification--warning {
            border-left-color: var(--color-warning);
        }
        
        .notification--info {
            border-left-color: var(--color-info);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.fade-out {
            animation: fadeOut var(--transition-normal) ease-out forwards;
        }
        
        /* Grid layout for components */
        .component-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        @media (max-width: 1024px) {
            .component-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Debug Panel (Hidden by default) -->
        <div id="debug-panel">
            <h4>üîß DEBUG INFO</h4>
            <div id="debug-info">Loading debug information...</div>
        </div>

        <!-- Header Component -->
        <div id="header-component"></div>

        <!-- Overview Grid -->
        <div class="grid grid--auto-fit">
            <!-- Overview Panel Component -->
            <div id="overview-panel-component"></div>
            
            <!-- Priority Breakdown (Placeholder for now) -->
            <div class="card">
                <h3>üéØ PRIORITY BREAKDOWN</h3>
                <div id="priority-breakdown">
                    <div class="loading">üîÑ Loading priorities...</div>
                </div>
            </div>
        </div>

        <!-- Component Grid -->
        <div class="component-grid">
            <!-- Jobs List Component -->
            <div id="jobs-list-component"></div>
            
            <!-- Agent Status Component -->
            <div id="agent-status-component"></div>
        </div>

        <!-- Additional components will be added here -->
        <div id="activity-log-component" class="card">
            <h3>üìù AGENT ACTIVITY LOG</h3>
            <div id="agent-todos-container" class="scrollable scrollable--md">
                <div class="loading">üîÑ Loading agent activities...</div>
            </div>
        </div>

        <div id="time-tracking-component" class="card">
            <h3>‚è±Ô∏è TIME TRACKING (<span id="active-session-count">0</span> active)</h3>
            <div id="time-sessions-container" class="scrollable scrollable--md">
                <div class="loading">üîÑ Loading time sessions...</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text--center mt--lg">
            <p class="text--muted">Last updated: <span id="last-updated">Loading...</span></p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Main Application Script -->
    <script>
        /**
         * Stratavore Web UI v4 - Modular Architecture
         * Main application initialization and orchestration
         */
        
        class StratavoreApp {
            constructor() {
                this.components = new Map();
                this.isInitialized = false;
                this.debugMode = false;
            }

            async initialize() {
                try {
                    console.log('üöÄ Initializing Stratavore Web UI v4...');
                    
                    // Setup global event handlers
                    this.setupGlobalEventHandlers();
                    
                    // Initialize components
                    await this.initializeComponents();
                    
                    // Start data polling
                    this.startDataPolling();
                    
                    // Setup auto-refresh
                    this.setupAutoRefresh();
                    
                    this.isInitialized = true;
                    console.log('‚úÖ Stratavore Web UI initialized successfully');
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize Stratavore Web UI:', error);
                    this.showNotification('Failed to initialize application', 'error');
                }
            }

            async initializeComponents() {
                const componentConfigs = [
                    { id: 'header-component', class: HeaderComponent, options: {} },
                    { id: 'overview-panel-component', class: OverviewPanelComponent, options: {} },
                    { id: 'jobs-list-component', class: JobsListComponent, options: {} },
                    { id: 'agent-status-component', class: AgentStatusComponent, options: {} }
                ];

                for (const config of componentConfigs) {
                    try {
                        const element = document.getElementById(config.id);
                        if (!element) {
                            console.warn(`Element not found for component: ${config.id}`);
                            continue;
                        }

                        const component = new config.class(config.id, config.options);
                        this.components.set(config.id, component);
                        
                        console.log(`üì¶ Component initialized: ${config.id}`);
                    } catch (error) {
                        console.error(`‚ùå Failed to initialize component ${config.id}:`, error);
                    }
                }
            }

            setupGlobalEventHandlers() {
                // Notification system
                window.StratavoreCore.eventBus.on('notification:show', (data) => {
                    this.showNotification(data.message, data.type);
                });

                // Refresh requests
                window.StratavoreCore.eventBus.on('refresh:requested', () => {
                    this.performManualRefresh();
                });

                // Debug toggle
                window.StratavoreCore.eventBus.on('debug:toggle', () => {
                    this.toggleDebug();
                });

                // Component error handling
                window.StratavoreCore.eventBus.on('component:error', (data) => {
                    console.error(`Component error in ${data.component}:`, data.error);
                    if (this.debugMode) {
                        this.updateDebugInfo({ error: data });
                    }
                });

                // Window resize with debouncing
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        window.StratavoreCore.eventBus.emit('window:resized');
                    }, 250);
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'F5') {
                        e.preventDefault();
                        this.performManualRefresh();
                    } else if (e.ctrlKey && e.key === 'd') {
                        e.preventDefault();
                        this.toggleDebug();
                    }
                });

                // Page visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pausePolling();
                    } else {
                        this.resumePolling();
                    }
                });
            }

            startDataPolling() {
                window.StratavoreCore.dataManager.startPolling();
                
                // Setup data change handlers
                window.StratavoreCore.dataStore.subscribe('lastUpdate', (timestamp) => {
                    this.updateLastUpdated(timestamp);
                    this.updateDebugInfo();
                });
            }

            setupAutoRefresh() {
                // Update every 30 seconds
                setInterval(() => {
                    this.updateLastUpdated(Date.now() / 1000);
                }, 30000);
            }

            async performManualRefresh() {
                try {
                    await window.StratavoreCore.dataManager.loadData();
                    this.showNotification('Data refreshed successfully', 'success');
                } catch (error) {
                    this.showNotification('Failed to refresh data', 'error');
                }
            }

            pausePolling() {
                window.StratavoreCore.dataManager.stopPolling();
            }

            resumePolling() {
                window.StratavoreCore.dataManager.startPolling();
            }

            toggleDebug() {
                this.debugMode = !this.debugMode;
                const debugPanel = document.getElementById('debug-panel');
                if (debugPanel) {
                    debugPanel.style.display = this.debugMode ? 'block' : 'none';
                }
                if (this.debugMode) {
                    this.updateDebugInfo();
                }
            }

            updateDebugInfo(customData = null) {
                if (!this.debugMode) return;

                const debugInfo = document.getElementById('debug-info');
                if (!debugInfo) return;

                const agents = window.StratavoreCore.dataStore.get('agents') || {};
                const jobs = window.StratavoreCore.dataStore.get('jobs') || [];
                const timeSessions = window.StratavoreCore.dataStore.get('timeSessions') || [];
                const lastUpdate = window.StratavoreCore.dataStore.get('lastUpdate');

                const agentCount = Object.keys(agents).length;
                const working = Object.values(agents).filter(a => a.status === 'working').length;
                const idle = Object.values(agents).filter(a => a.status === 'idle').length;

                let debugContent = `
                    <p><strong>Timestamp:</strong> ${lastUpdate ? new Date(lastUpdate * 1000).toLocaleString() : 'N/A'}</p>
                    <p><strong>Jobs:</strong> ${jobs.length} ¬∑ <strong>Sessions:</strong> ${timeSessions.length}</p>
                    <p><strong>Agents total:</strong> ${agentCount} ¬∑ <strong>Working:</strong> ${working} ¬∑ <strong>Idle:</strong> ${idle}</p>
                    <p><strong>Components loaded:</strong> ${this.components.size}</p>
                    <p><strong>Debug mode:</strong> ${this.debugMode ? 'ON' : 'OFF'}</p>
                `;

                if (customData && customData.error) {
                    debugContent += `<p><strong>Last Error:</strong> ${customData.error.component} - ${customData.error.error.message}</p>`;
                }

                debugInfo.innerHTML = debugContent;
            }

            updateLastUpdated(timestamp) {
                const lastUpdatedEl = document.getElementById('last-updated');
                if (lastUpdatedEl) {
                    lastUpdatedEl.textContent = new Date(timestamp * 1000).toLocaleString();
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification notification--${type}`;
                notification.textContent = message;

                container.appendChild(notification);

                // Auto-remove after 4 seconds
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 4000);
            }

            // Cleanup method
            destroy() {
                // Unmount all components
                this.components.forEach((component, id) => {
                    try {
                        component.unmount();
                    } catch (error) {
                        console.error(`Error unmounting component ${id}:`, error);
                    }
                });

                // Stop data polling
                window.StratavoreCore.dataManager.stopPolling();

                // Clear event bus
                window.StratavoreCore.eventBus.clear();

                this.components.clear();
                this.isInitialized = false;
            }
        }

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            const app = new StratavoreApp();
            await app.initialize();

            // Make app globally accessible for debugging
            window.StratavoreApp = app;
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.StratavoreApp) {
                window.StratavoreApp.destroy();
            }
        });
    </script>
</body>
</html>